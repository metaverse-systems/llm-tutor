# Data Model: LLM Profile IPC Handlers

**Feature**: 008-llm-profile-ipc  
**Phase**: 1 (Design & Contracts)  
**Date**: 2025-10-11

## Domain Entities

### 1. ProfileIpcEnvelope
**Purpose**: Canonical message wrapper for renderer → main and main → renderer IPC traffic.

**Fields**:
```typescript
interface ProfileIpcEnvelope<TPayload> {
  channel: ProfileIpcChannel;    // e.g., 'llmProfile:list'
  requestId: string;             // UUID v4 generated by renderer
  timestamp: number;             // Epoch ms when message dispatched
  payload: TPayload;             // Typed request payload for channel
  context: OperatorContext;      // Authenticated operator metadata
}
```

**Validation Rules**:
- `channel`: Must be one of the seven allow-listed strings.
- `requestId`: Valid UUID v4.
- `timestamp`: Positive integer, must be within ±5 minutes of main process clock (reject stale/future messages).
- `context.operatorRole`: Enum `"instructional_technologist" | "curriculum_lead" | "support_engineer"` mapped from desktop auth.
- `context.locale`: BCP 47 language tag; defaults to `"en-US"`.

**Relationships**:
- Envelope payload references channel-specific request objects (see below).

---

### 2. ProfileOperationRequest
**Purpose**: Channel-specific payload union describing intent for CRUD + activation operations.

**Fields**:
```typescript
type ProfileOperationRequest =
  | { type: 'list'; filter?: ProfileListFilter }
  | { type: 'create'; profile: DraftProfile }
  | { type: 'update'; profileId: string; changes: Partial<DraftProfile> }
  | { type: 'delete'; profileId: string }
  | { type: 'activate'; profileId: string; force?: boolean }
  | { type: 'test'; profileId: string; promptOverride?: string }
  | { type: 'discover'; scope: DiscoveryScope };
```

**Supporting Types**:
```typescript
interface ProfileListFilter {
  providerTypes?: ProviderType[];   // Optional targeted filter
  includeDiagnostics?: boolean;     // Enrich with last error
}

interface DraftProfile {
  name: string;
  providerType: ProviderType;
  endpointUrl: string;
  apiKey: string;
  modelId?: string | null;
  consentTimestamp?: number | null;
}

interface DiscoveryScope {
  strategy: 'local' | 'remote';     // Local: llama.cpp/Ollama; Remote: Azure
  timeoutMs: number;                // 1000-5000 ms range
}
```

**Validation Rules**:
- `profileId`: Required UUID v4.
- `DraftProfile.name`: 1-100 chars, trimmed.
- `DraftProfile.endpointUrl`: Valid URL; HTTPS required for remote providers.
- `timeoutMs`: Clamp to 1000-5000 range; default 3000.

---

### 3. ProfileOperationResponse
**Purpose**: Normalized result object returned to renderer.

**Fields**:
```typescript
interface ProfileOperationResponse<TData = unknown> {
  requestId: string;              // Echo from request envelope
  channel: ProfileIpcChannel;
  success: boolean;
  code: ProfileErrorCode | 'OK';  // Enumerated error codes
  data: TData | null;             // Typed payload when success
  userMessage: string;            // Accessible copy for screen readers
  remediation?: string | null;    // Optional next steps
  debug?: DebugDetails | null;    // Populated only in non-production builds
  correlationId: string;          // UUID for diagnostics linkage
  durationMs: number;             // Handler runtime excluding network I/O
  safeStorageStatus: 'available' | 'unavailable';
}
```

**Validation Rules**:
- `success`: Must align with `code === 'OK'`.
- `userMessage`: 1-200 chars, plain language.
- `durationMs`: Non-negative integer; enforce <500 ms budget.

**Relationships**:
- `data` references typed response objects per channel (see below).
- `correlationId` links to `DiagnosticsBreadcrumb` entity.

---

### 4. Channel Response Payloads
**Purpose**: Detailed response types for each channel.

**Fields**:
```typescript
interface ListProfilesResponse {
  profiles: ProfileSummary[];
  diagnostics?: ProfileDiagnosticsSummary[];
}

interface CreateOrUpdateResponse {
  profile: ProfileSummary;
}

interface DeleteResponse {
  deletedId: string;
}

interface ActivateResponse {
  activeProfile: ProfileSummary;
  previousProfileId: string | null;
}

interface TestResponse {
  profileId: string;
  success: boolean;
  latencyMs: number | null;
  totalTimeMs: number;
  modelName?: string | null;
  truncatedResponse?: string | null;
}

interface DiscoverResponse {
  providers: DiscoveredProvider[];
}
```

**Supporting Types**:
```typescript
interface ProfileSummary {
  id: string;
  name: string;
  providerType: ProviderType;
  endpointUrl: string;
  isActive: boolean;
  consentTimestamp: number | null;
  lastModified: number;
}

interface ProfileDiagnosticsSummary {
  profileId: string;
  lastErrorCode: ProfileErrorCode | null;
  lastErrorAt: number | null;
}

interface DiscoveredProvider {
  providerType: ProviderType;
  endpointUrl: string;
  latencyMs: number | null;
  requiresConsent: boolean;
}
```

**Validation Rules**:
- `ProfileSummary.endpointUrl`: Mask secrets before returning (`apiKey` never leaves main process).
- `TestResponse.truncatedResponse`: Max 500 characters; sanitized for HTML/JS.
- `DiscoverResponse.providers`: Limit to 25 entries to keep UI performant.

---

### 5. DiagnosticsBreadcrumb
**Purpose**: Telemetry entry written for every handler invocation.

**Fields**:
```typescript
interface DiagnosticsBreadcrumb {
  id: string;                     // UUID v4
  channel: ProfileIpcChannel;
  requestId: string;
  correlationId: string;
  operatorRole: OperatorRole;
  durationMs: number;
  resultCode: ProfileErrorCode | 'OK';
  safeStorageStatus: 'available' | 'unavailable';
  createdAt: number;              // Epoch ms
  metadata: Record<string, unknown>; // Additional non-sensitive data
}
```

**Validation Rules**:
- `durationMs`: Non-negative; warn when ≥450.
- `metadata`: Must exclude `apiKey`, raw prompts, or PII strings.

**Storage**:
- Appended to diagnostics JSONL at `app.getPath('userData')/diagnostics/profile-ipc.jsonl`.

---

### 6. SafeStorageOutageState
**Purpose**: Tracks active outage window when encryption is unavailable.

**Fields**:
```typescript
interface SafeStorageOutageState {
  isActive: boolean;              // True when outage detected
  startedAt: number | null;       // Epoch ms of first detection
  resolvedAt: number | null;      // Epoch ms when availability restored
  blockedRequestIds: string[];    // Request IDs refused during outage
}
```

**State Transitions**:
```
[Nominal] --(safeStorage false)--> [Outage]
[Outage] --(safeStorage true)--> [Recovered]
[Recovered] --(new outage)--> [Outage]
```

**Validation Rules**:
- `blockedRequestIds`: Trim to last 50 entries to prevent unbounded growth.
- When transitioning to `[Recovered]`, flush state and emit recovery diagnostics event.

---

## Type Definitions (Shared Package)

Location: `packages/shared/src/contracts/llm-profile-ipc.ts`

```typescript
export const ProfileIpcChannelSchema = z.enum([
  'llmProfile:list',
  'llmProfile:create',
  'llmProfile:update',
  'llmProfile:delete',
  'llmProfile:activate',
  'llmProfile:test',
  'llmProfile:discover',
]);
export type ProfileIpcChannel = z.infer<typeof ProfileIpcChannelSchema>;

export const OperatorContextSchema = z.object({
  operatorId: z.string().uuid(),
  operatorRole: z.enum(['instructional_technologist', 'curriculum_lead', 'support_engineer']),
  locale: z.string().regex(/^[a-z]{2,3}(-[A-Z]{2})?$/).default('en-US'),
});

export const ProfileErrorCodeSchema = z.enum([
  'OK',
  'PROFILE_NOT_FOUND',
  'VALIDATION_ERROR',
  'CONFLICT_ACTIVE_PROFILE',
  'SAFE_STORAGE_UNAVAILABLE',
  'SERVICE_FAILURE',
  'DISCOVERY_CONFLICT',
  'VAULT_READ_ERROR',
  'RATE_LIMITED',
  'TIMEOUT',
]);
// ...additional schemas derived from entities above
```

---

## Service Responsibilities

### ProfileIpcRouter (`apps/desktop/src/main/ipc/profile-ipc.router.ts`)
- Register all seven IPC channels via `ipcMain.handle`
- Wrap ProfileService/TestPromptService/AutoDiscoveryService calls
- Enforce schema validation, diagnostics logging, and safeStorage gating
- Manage lifecycle with `dispose()` to unregister handlers and flush diagnostics

### ProfileRendererBridge (`apps/desktop/src/renderer/services/profile-ipc.client.ts`)
- Provide contextBridge wrappers that expose typed methods to UI
- Serialize requests into `ProfileIpcEnvelope`
- Handle structured responses and surface localized messages to components

### DiagnosticsRecorder (`apps/desktop/src/main/diagnostics/profile-ipc.recorder.ts`)
- Stream breadcrumbs to JSONL file with rotation policy
- Monitor performance thresholds, emit warnings for SLO breaches
- Coordinate safeStorage outage notifications with renderer toast system

---

## Open Questions
- None. Research clarifications resolved outstanding uncertainties.
